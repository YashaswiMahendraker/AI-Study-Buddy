<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI Study Buddy - JEE, NEET, UPSC</title>
        <!-- Load Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Use Inter font -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

        <style>
            /* Custom styles for the loader and general typography */
            body {
                font-family: 'Inter', sans-serif;
            }
        </style>
    </head>
    <body class="bg-gray-50 flex items-center justify-center min-h-screen p-4" style="font-family: 'Inter', sans-serif;">

        <!-- Loader Screen (This will hide the loading screen immediately upon running the script below) -->
        <div id="app-loader" class="text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">AI Study Buddy</h1>
            <p class="text-gray-600 mb-8">Your free AI tutor for JEE, NEET & UPSC</p>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-indigo-600">Setting up your study session...</p>
        </div>

        <!-- Main Content (Hidden until script runs) -->
        <div id="main-content" class="hidden bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-lg transition-all duration-500">
            <!-- Header -->
            <div class="mb-6 border-b pb-4">
                <h1 class="text-3xl font-extrabold text-indigo-700 text-center">AI Study Buddy</h1>
                <p class="text-sm text-gray-500 text-center mt-1">Free Tutor for JEE, NEET, UPSC</p>
                <div class="mt-2 text-xs text-gray-400 text-center" id="user-id-display"></div>
            </div>

            <!-- Exam Selection -->
            <div class="mb-6">
                <label for="exam-select" class="block text-sm font-medium text-gray-700 mb-2">1. Select Your Exam Focus</label>
                <select id="exam-select" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 ease-in-out bg-white">
                    <option value="UPSC" selected>UPSC (Civil Services)</option>
                    <option value="JEE">JEE (Engineering Entrance)</option>
                    <option value="NEET">NEET (Medical Entrance)</option>
                </select>
            </div>

            <!-- Question Input -->
            <div class="mb-6">
                <label for="user-input" class="block text-sm font-medium text-gray-700 mb-2">2. Ask Your Question</label>
                <textarea id="user-input" rows="3" placeholder="Example: Explain the core principles of quantum mechanics for JEE."
                    class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 ease-in-out resize-none"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col space-y-3 mb-6">
                <button id="get-answer-btn"
                    class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                    <span id="button-text">Get Answer</span>
                </button>
                <button id="get-quiz-btn" disabled
                    class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-150 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Generate Practice Quiz
                </button>
            </div>

            <!-- Response Area -->
            <div id="response-area" class="mt-6 p-4 bg-gray-100 rounded-lg shadow-inner overflow-y-auto max-h-96">
                <p class="text-gray-500 text-sm">Your AI-generated explanation and quiz will appear here.</p>
            </div>
        </div>

    </body>

    <!-- Load Firebase and Core Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Firestore path helpers
        const getExamDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'exam_preference', 'current_exam');

        // Initialize Firebase and Authenticate
        async function initializeAppAndAuth() {
            // NOTE: The UI is activated outside this function to ensure it loads immediately on GitHub Pages.
            try {
                if (!firebaseConfig.apiKey) {
                    // Fallback for environments where Firebase config is not provided (like GitHub Pages)
                    isAuthReady = true;
                    userId = crypto.randomUUID(); // Set a dummy ID
                    document.getElementById('user-id-display').textContent = `User ID: ${userId} (Storage Disabled)`;
                    console.warn("Firebase configuration missing. Running in AI-only mode (No preference saving).");
                } else {
                    // Original Firebase initialization path
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    // setLogLevel('Debug'); 

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                            isAuthReady = true;
                            loadExamPreference();
                        } else {
                            userId = crypto.randomUUID(); 
                            document.getElementById('user-id-display').textContent = `Anonymous User ID: ${userId}`;
                            isAuthReady = true;
                        }
                    });
                }
            } catch (error) {
                console.error("App initialization failed (Firebase/Auth):", error);
                document.getElementById('app-loader').innerHTML = '<p class="text-red-600">Fatal error during startup. Check console.</p>';
                document.getElementById('app-loader').classList.remove('hidden'); // Ensure error message is visible
            }
        }

        // --- Core Application Logic ---

        const userInput = document.getElementById('user-input');
        const examSelect = document.getElementById('exam-select');
        const getAnswerBtn = document.getElementById('get-answer-btn');
        const getQuizBtn = document.getElementById('get-quiz-btn');
        const responseArea = document.getElementById('response-area');
        const buttonText = document.getElementById('button-text');
        
        let lastAnswer = '';
        let currentExam = 'UPSC';

        // Helper for Exponential Backoff
        const MAX_RETRIES = 3;
        const INITIAL_DELAY_MS = 1000;
        
        // Base64 to Array Buffer (for future TTS/Audio use, if implemented)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Fetching Data with Retries (for robustness)
        async function fetchWithRetry(url, options) {
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt < MAX_RETRIES - 1) {
                        const delay = INITIAL_DELAY_MS * Math.pow(2, attempt) + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Gemini API Interaction (Text Generation)
        async function generateContent(userQuery, systemPrompt, useGrounding = false) {
            const apiKey = ""; 
            const model = 'gemini-2.5-flash-preview-09-2025';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };
                } else {
                    console.error("API response missing text content:", result);
                    return { text: "Sorry, I couldn't generate a response. Please try again.", sources: [] };
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return { text: `Error generating content: ${error.message}`, sources: [] };
            }
        }
        
        // --- Firestore Operations (Simplified to ensure non-breaking behavior) ---

        async function saveExamPreference(exam) {
            if (!db || !isAuthReady) {
                console.warn("Database not ready or running in storage-disabled mode. Cannot save preference.");
                return;
            }
            try {
                await setDoc(getExamDocRef(userId), { exam: exam, timestamp: new Date().toISOString() });
            } catch (error) {
                console.error("Error saving exam preference:", error);
            }
        }

        async function loadExamPreference() {
            if (!db || !isAuthReady) return;
            try {
                const docSnap = await getDoc(getExamDocRef(userId));
                if (docSnap.exists()) {
                    const savedExam = docSnap.data().exam;
                    if (['JEE', 'NEET', 'UPSC'].includes(savedExam)) {
                        examSelect.value = savedExam;
                        currentExam = savedExam;
                        // console.log(`Loaded preference: ${savedExam}`);
                    }
                }
            } catch (error) {
                console.error("Error loading exam preference:", error);
            }
        }

        // --- Event Handlers ---

        async function handleGetAnswer() {
            const query = userInput.value.trim();
            if (!query) {
                responseArea.innerHTML = '<p class="text-red-500">Please enter a question first.</p>';
                return;
            }

            getAnswerBtn.disabled = true;
            getQuizBtn.disabled = true;
            buttonText.textContent = "Thinking...";
            responseArea.innerHTML = '<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div></div>';
            lastAnswer = ''; // Clear previous answer

            // 1. Generate Study Material
            const systemPrompt = `You are a world-class study tutor specializing in competitive exams. The user's focus is ${currentExam}. Provide a comprehensive, accurate, and easy-to-understand explanation specifically tailored to the knowledge depth required for the ${currentExam} exam. Use appropriate technical vocabulary for the specified exam level.`;
            const userQuery = `Explain the following topic for the ${currentExam} exam: ${query}`;
            
            const result = await generateContent(userQuery, systemPrompt, true);
            lastAnswer = result.text;
            
            // 2. Format and Display
            let htmlContent = `<h3 class="text-xl font-bold text-indigo-700 mb-2">‚úÖ Explanation for ${currentExam}:</h3>`;
            htmlContent += `<div class="p-3 bg-white rounded-lg border border-gray-200">${lastAnswer.replace(/\n/g, '<br>')}</div>`;
            
            if (result.sources && result.sources.length > 0) {
                htmlContent += `<p class="text-xs mt-3 text-gray-500">Grounded in the following sources:</p><ul class="list-disc list-inside text-xs text-gray-500 mt-1">`;
                result.sources.slice(0, 3).forEach(source => {
                    htmlContent += `<li><a href="${source.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700">${source.title}</a></li>`;
                });
                htmlContent += `</ul>`;
            }
            
            responseArea.innerHTML = htmlContent;

            getAnswerBtn.disabled = false;
            getQuizBtn.disabled = true; // Still disabled until a successful answer
            buttonText.textContent = "Get Answer";

            if (lastAnswer && !lastAnswer.includes("Error generating content")) {
                 getQuizBtn.disabled = false; // Enable quiz only on success
            }
        }

        async function handleGetQuiz() {
            if (!lastAnswer) {
                responseArea.innerHTML = '<p class="text-red-500">Please get an explanation first before requesting a quiz.</p>';
                return;
            }

            getAnswerBtn.disabled = true;
            getQuizBtn.disabled = true;
            buttonText.textContent = "Generating Quiz...";

            // 1. Generate Quiz
            const systemPrompt = `You are a quiz master. Create a short, challenging quiz based ONLY on the provided explanation. Generate exactly two multiple-choice questions (MCQs) and one short answer question (SAQ) suitable for a student preparing for the ${currentExam} exam. Do not include answers in your response.`;
            const userQuery = `Generate a 2-question MCQ and 1-question SAQ based on this text: \n\n${lastAnswer}`;
            
            const result = await generateContent(userQuery, systemPrompt, false);
            
            // 2. Format and Display
            let htmlContent = `<h3 class="text-xl font-bold text-green-600 mt-6 mb-2">üìù Practice Quiz:</h3>`;
            htmlContent += `<div class="p-3 bg-white rounded-lg border border-gray-200">${result.text.replace(/\n/g, '<br>')}</div>`;

            responseArea.innerHTML += htmlContent;

            getAnswerBtn.disabled = false;
            getQuizBtn.disabled = false;
            buttonText.textContent = "Get Answer";
        }

        function handleExamChange() {
            currentExam = examSelect.value;
            // Save preference, but only if Firebase is initialized
            if (isAuthReady) {
                saveExamPreference(currentExam);
            }
        }

        // --- Initialization and Event Listeners ---

        // 1. Activate UI immediately (Moved here to bypass browser caching of the loading state)
        document.getElementById('app-loader').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        // 2. Start Firebase/Auth setup in the background
        initializeAppAndAuth();

        // 3. Attach Event Listeners
        getAnswerBtn.addEventListener('click', handleGetAnswer);
        getQuizBtn.addEventListener('click', handleGetQuiz);
        examSelect.addEventListener('change', handleExamChange);
        
        // Allow ENTER key to trigger search
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !getAnswerBtn.disabled) {
                e.preventDefault();
                handleGetAnswer();
            }
        });

    </script>
    <!-- CACHE BUSTER 20251101_FINAL -->
</html>
