<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Buddy - JEE, NEET, UPSC</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinning loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Markdown-like formatting for the output */
        #response-area h3, #quiz-area h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        #response-area ul, #quiz-area ul {
            list-style-type: disc;
            margin-left: 1.5rem; /* ml-6 */
            margin-bottom: 1rem; /* mb-4 */
        }
        #response-area ol, #quiz-area ol {
            list-style-type: decimal;
            margin-left: 1.5rem; /* ml-6 */
            margin-bottom: 1rem; /* mb-4 */
        }
        #response-area li, #quiz-area li {
            margin-bottom: 0.25rem; /* mb-1 */
        }
        #response-area p, #quiz-area p {
            margin-bottom: 1rem; /* mb-4 */
        }
        #response-area strong, #response-area b, #quiz-area strong, #quiz-area b {
            font-weight: 600; /* font-semibold */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl p-6 sm:p-8 rounded-2xl shadow-xl">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">AI Study Buddy</h1>
            <p class="text-gray-600 mt-2">Your free AI tutor for JEE, NEET & UPSC</p>
        </div>

        <!-- Initial App Loader -->
        <div id="app-loader" class="text-center py-10">
            <div class="loader mx-auto"></div>
            <p class="text-gray-600 mt-4">Setting up your study session...</p>
        </div>

        <!-- Main Content (Hidden until Firebase is ready) -->
        <div id="main-content" class="space-y-6 hidden">
            <!-- Exam Selector -->
            <div>
                <label for="exam-select" class="block text-sm font-medium text-gray-700 mb-2">
                    1. Select your exam:
                </label>
                <select id="exam-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option value="JEE">JEE (Engineering)</option>
                    <option value="NEET">NEET (Medical)</option>
                    <option value="UPSC">UPSC (Civil Services)</option>
                </select>
                <p id="user-id-display" class="text-xs text-gray-500 mt-1"></p>
            </div>

            <!-- Question Input -->
            <div>
                <label for="query-input" class="block text-sm font-medium text-gray-700 mb-2">
                    2. Ask your question:
                </label>
                <textarea id="query-input" rows="5" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., Explain Newton's First Law of Motion with an example."></textarea>
            </div>

            <!-- Submit Button -->
            <button id="submit-button" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform transform active:scale-95">
                Get Answer
            </button>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="mt-8 pt-6 border-t border-gray-200">
            <!-- Loader -->
            <div id="loader" class="text-center hidden">
                <div class="loader mx-auto"></div>
                <p class="text-gray-600 mt-4">Finding the best answer for you...</p>
            </div>
            
            <!-- Quiz Loader -->
            <div id="quiz-loader" class="text-center hidden">
                <div class="loader mx-auto"></div>
                <p class="text-gray-600 mt-4">Generating your practice quiz...</p>
            </div>

            <!-- Response Area -->
            <div id="response-container" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Here's your explanation:</h2>
                <div id="response-area" class="text-gray-700 leading-relaxed bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <!-- AI response will be injected here -->
                </div>

                <!-- Quiz Button -->
                <button id="quiz-button" class="mt-4 w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform transform active:scale-95">
                    Generate Practice Quiz (5 MCQs)
                </button>

                <!-- Sources -->
                <div id="sources-container" class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Sources:</h3>
                    <ul id="sources-list" class="list-disc list-inside text-blue-600">
                        <!-- Sources will be injected here -->
                    </ul>
                </div>
            </div>

            <!-- Quiz Area -->
            <div id="quiz-container" class="hidden mt-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Practice Quiz:</h2>
                <div id="quiz-area" class="text-gray-700 leading-relaxed bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <!-- Quiz content will be injected here -->
                </div>
            </div>


            <!-- Error Message -->
            <div id="error-message" class="hidden text-red-600 bg-red-50 p-4 rounded-lg border border-red-200">
                <!-- Error content here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE VARIABLES & SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // Firestore path helpers
        const getExamDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'settings', 'exam_preference');

        // Initialize Firebase and Authenticate
        
            // FIX: Bypass Firebase setup for GitHub Pages environment
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                if (!firebaseConfig.apiKey) {
                    // Fallback for environments where Firebase config is not provided (like GitHub Pages)
                    isAuthReady = true;
                    userId = crypto.randomUUID(); // Set a dummy ID
                    document.getElementById('user-id-display').textContent = `User ID: ${userId} (Storage Disabled)`;
                    console.warn("Firebase configuration missing. Running in AI-only mode (No preference saving).");
                } else {
                    // Original Firebase initialization path
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                            isAuthReady = true;
                            loadExamPreference();
                        } else {
                            userId = crypto.randomUUID(); 
                            document.getElementById('user-id-display').textContent = `Anonymous User ID: ${userId}`;
                            isAuthReady = true;
                        }
                    });
                }
                
                // Final UI activation for both paths
                document.getElementById('app-loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error("App initialization failed:", error);
                document.getElementById('app-loader').innerHTML = '<p class="text-red-600">Fatal error during startup. Check console.</p>';
            }
        }

                // setLogLevel('Debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state change to get the final user ID
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        
                        // Proceed to load data and hide the initial loader
                        loadExamPreference();
                        document.getElementById('app-loader').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                    } else {
                        // This case typically won't happen if sign-in is successful
                        userId = crypto.randomUUID(); 
                        document.getElementById('user-id-display').textContent = `Anonymous User ID: ${userId}`;
                        isAuthReady = true;
                        document.getElementById('app-loader').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('app-loader').innerHTML = '<p class="text-red-600">Error loading app. See console for details.</p>';
            }
        }
        
        // --- Firestore Data Handlers ---

        /**
         * Loads the user's last saved exam preference from Firestore.
         */
        async function loadExamPreference() {
            if (!isAuthReady || !db || !userId) return;

            try {
                const docRef = getExamDocRef(userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.exam) {
                        examSelect.value = data.exam;
                        console.log(`Loaded exam preference: ${data.exam}`);
                    }
                }
            } catch (error) {
                console.error("Error loading exam preference:", error);
            }
        }

        /**
         * Saves the current exam preference to Firestore.
         */
        async function saveExamPreference(exam) {
            if (!isAuthReady || !db || !userId) {
                console.warn("Cannot save: Auth not ready or User ID missing.");
                return;
            }

            try {
                const docRef = getExamDocRef(userId);
                await setDoc(docRef, { exam: exam }, { merge: true });
                console.log(`Saved exam preference: ${exam}`);
            } catch (error) {
                console.error("Error saving exam preference:", error);
            }
        }

        // --- DOM Elements and Event Handlers ---
        
        // Get DOM elements
        const examSelect = document.getElementById('exam-select');
        const queryInput = document.getElementById('query-input');
        const submitButton = document.getElementById('submit-button');
        const quizButton = document.getElementById('quiz-button');
        const loader = document.getElementById('loader');
        const quizLoader = document.getElementById('quiz-loader');
        const responseContainer = document.getElementById('response-container');
        const responseArea = document.getElementById('response-area');
        const sourcesContainer = document.getElementById('sources-container');
        const sourcesList = document.getElementById('sources-list');
        const errorMessage = document.getElementById('error-message');
        const quizContainer = document.getElementById('quiz-container');
        const quizArea = document.getElementById('quiz-area');

        // State to store the last successful query for quiz generation
        let lastSuccessfulQuery = '';

        // Add event listeners
        submitButton.addEventListener('click', handleQuery);
        quizButton.addEventListener('click', handleQuizGeneration);
        examSelect.addEventListener('change', (e) => saveExamPreference(e.target.value));

        // Start the initialization process
        initializeAppAndAuth();


        /**
         * Fetches data with exponential backoff retry logic.
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    // 5xx errors are server-side and worth retrying
                    if (response.status >= 500 && response.status < 600) {
                        throw new Error(`Server Error: ${response.status}`);
                    }
                    return response; // Success or non-retryable error
                } catch (error) {
                    if (i === retries - 1) throw error; // Last retry failed
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        /**
         * Main function to handle the user's initial query and get the explanation
         */
        async function handleQuery() {
            if (!isAuthReady) {
                 displayError("App is still initializing. Please wait a moment.");
                 return;
            }
            
            const selectedExam = examSelect.value;
            const userQuery = queryInput.value.trim();

            if (!userQuery) {
                displayError("Please enter a question.");
                return;
            }

            // Reset UI state
            loader.classList.remove('hidden');
            responseContainer.classList.add('hidden');
            quizContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.textContent = 'Thinking...';
            quizButton.disabled = true;
            lastSuccessfulQuery = '';

            try {
                // Define the system prompt based on the selected exam
                const systemPrompt = `You are an expert AI tutor. Your student is preparing for the ${selectedExam} exam. 
                Provide a clear, concise, and accurate answer to their question. 
                - For JEE: Focus on concepts in Physics, Chemistry, and Math.
                - For NEET: Focus on concepts in Physics, Chemistry, and Biology (Zoology & Botany).
                - For UPSC: Focus on concepts related to Indian History, Polity, Geography, Economy, Current Events, and general studies.
                Break down complex topics into simple, easy-to-understand points. Use bullet points or numbered lists where helpful. 
                Your tone should be encouraging and supportive.`;

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    tools: [{ "google_search": {} }],
                };

                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!result.ok) {
                    throw new Error(`API Error: ${result.status} ${result.statusText}`);
                }

                const data = await result.json();
                const candidate = data.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const groundingMetadata = candidate.groundingMetadata;
                    
                    let sources = [];
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => attr.web?.uri ? ({ uri: attr.web.uri, title: attr.web.title || attr.web.uri }) : null)
                            .filter(source => source); 
                    }

                    // Store query and display response
                    lastSuccessfulQuery = userQuery;
                    displayResponse(text, sources);
                    quizButton.disabled = false;
                } else {
                    displayError("Sorry, I couldn't find an answer to that. Please try rephrasing your question.");
                }

            } catch (error) {
                console.error('Error fetching from API:', error);
                displayError(`An error occurred: ${error.message}. Please check your input and try again.`);
            } finally {
                loader.classList.add('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'Get Answer';
            }
        }

        /**
         * Function to generate a quiz based on the last successful query.
         */
        async function handleQuizGeneration() {
            if (!lastSuccessfulQuery) {
                displayError("Please get an answer first before generating a quiz.");
                return;
            }

            // UI state for quiz generation
            quizContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            quizLoader.classList.remove('hidden');
            quizButton.disabled = true;
            quizButton.textContent = 'Generating...';

            try {
                const quizPrompt = `Generate a set of 5 multiple-choice questions (MCQs) related to the topic: "${lastSuccessfulQuery}". 
                The questions should be appropriate for a student preparing for the ${examSelect.value} exam.
                For each question, provide 4 options (A, B, C, D) and specify the correct answer clearly.
                Format the entire output as a continuous block of text, clearly numbering each question and providing the correct answer at the end of the question block. 
                Do not include any introductory or concluding sentences.`;

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: quizPrompt }] }],
                };

                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!result.ok) {
                    throw new Error(`API Error: ${result.status} ${result.statusText}`);
                }

                const data = await result.json();
                const candidate = data.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const quizText = candidate.content.parts[0].text;
                    displayQuiz(quizText);
                } else {
                    displayError("Could not generate the quiz. Please try again.");
                }

            } catch (error) {
                console.error('Error generating quiz:', error);
                displayError(`An error occurred while generating the quiz: ${error.message}`);
            } finally {
                quizLoader.classList.add('hidden');
                quizButton.disabled = false;
                quizButton.textContent = 'Generate Practice Quiz (5 MCQs)';
            }
        }


        /**
         * Displays the AI's explanation response in the UI.
         */
        function displayResponse(text, sources) {
            // Basic formatting for the explanation area
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/\*(.*?)\*/g, '<em>$1</em>')       
                .replace(/### (.*?)\n/g, '<h3>$1</h3>')     
                .replace(/## (.*?)\n/g, '<h2>$1</h2>')       
                .replace(/# (.*?)\n/g, '<h1>$1</h1>')        
                .replace(/^- (.*?)\n/gm, '<ul><li>$1</li></ul>') 
                .replace(/^\d+\. (.*?)\n/gm, '<ol><li>$1</li></ol>') 
                .replace(/<\/ul>\n<ul>/g, '') 
                .replace(/<\/ol>\n<ol>/g, '') 
                .replace(/\n/g, '<br>');                     

            responseArea.innerHTML = formattedText;
            responseContainer.classList.remove('hidden');

            // Populate sources
            if (sources.length > 0) {
                sourcesList.innerHTML = '';
                sources.forEach(source => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="hover:underline">${source.title}</a>`;
                    sourcesList.appendChild(li);
                });
                sourcesContainer.classList.remove('hidden');
            } else {
                sourcesContainer.classList.add('hidden');
            }
        }

        /**
         * Displays the generated quiz in the UI.
         */
        function displayQuiz(text) {
             // Basic formatting for the quiz area to handle newlines as paragraphs/breaks
             let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/\n/g, '<br><br>');

            quizArea.innerHTML = formattedText;
            quizContainer.classList.remove('hidden');
        }

        /**
         * Displays an error message in the UI.
         */
        function displayError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>
<!-- CACHE BUSTER 20251101 -->
