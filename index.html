<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI Study Buddy - JEE, NEET, UPSC</title>
        <!-- Load Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Use Inter font -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

        <style>
            /* Custom styles for the loader and general typography */
            body {
                font-family: 'Inter', sans-serif;
            }
            /* Styling for the <pre> tag used for model output to look clean */
            #response-area pre {
                white-space: pre-wrap;
                word-wrap: break-word;
                font-size: 1rem;
                line-height: 1.5;
            }
        </style>
    </head>
    <body class="bg-gray-50 flex items-center justify-center min-h-screen p-4" style="font-family: 'Inter', sans-serif;">

        <!-- Loader Screen (This will hide the loading screen immediately upon running the script below) -->
        <div id="app-loader" class="text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">AI Study Buddy</h1>
            <p class="text-gray-600 mb-8">Your free AI tutor for JEE, NEET & UPSC</p>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-indigo-600">Setting up your study session...</p>
        </div>

        <!-- Main Content (Hidden until script runs) -->
        <div id="main-content" class="hidden bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-lg transition-all duration-500">
            <!-- Header -->
            <div class="mb-6 border-b pb-4">
                <h1 class="text-3xl font-extrabold text-indigo-700 text-center">AI Study Buddy</h1>
                <p class="text-sm text-gray-500 text-center mt-1">Free Tutor for JEE, NEET, UPSC</p>
                <div class="mt-2 text-xs text-gray-400 text-center" id="user-id-display"></div>
            </div>

            <!-- API Key Input Section (NEW) -->
            <div id="api-key-section" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <label for="api-key-input" class="block text-sm font-medium text-red-700 mb-2">
                    üö® External API Key Required
                </label>
                <input type="password" id="api-key-input" placeholder="Paste your Gemini API Key here"
                       class="w-full p-2 border border-red-300 rounded-lg focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 transition duration-150 ease-in-out bg-white text-sm">
                <p class="text-xs text-red-600 mt-2">
                    This key is needed to run the AI features outside the secure Google environment. It is saved in your browser's local storage.
                </p>
                <button id="save-api-key-btn" class="mt-3 w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700 transition">
                    Save Key & Start
                </button>
            </div>
            
            <!-- App Controls (Initially hidden if key is missing) -->
            <div id="app-controls" class="hidden">
                <!-- Exam Selection -->
                <div class="mb-6">
                    <label for="exam-select" class="block text-sm font-medium text-gray-700 mb-2">1. Select Your Exam Focus</label>
                    <select id="exam-select" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 ease-in-out bg-white">
                        <option value="UPSC" selected>UPSC (Civil Services)</option>
                        <option value="JEE">JEE (Engineering Entrance)</option>
                        <option value="NEET">NEET (Medical Entrance)</option>
                    </select>
                </div>

                <!-- Question Input -->
                <div class="mb-6">
                    <label for="user-input" class="block text-sm font-medium text-gray-700 mb-2">2. Ask Your Question</label>
                    <textarea id="user-input" rows="3" placeholder="Example: Explain the core principles of quantum mechanics for JEE."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 ease-in-out resize-none"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col space-y-3 mb-6">
                    <button id="get-answer-btn"
                        class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                        <span id="button-text">Get Answer</span>
                    </button>
                    <button id="get-quiz-btn" disabled
                        class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-150 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Generate Practice Quiz
                    </button>
                </div>
            </div> <!-- End App Controls -->

            <!-- Response Area -->
            <div id="response-area" class="mt-6 p-4 bg-gray-100 rounded-lg shadow-inner overflow-y-auto max-h-96">
                <p class="text-gray-500 text-sm">Your AI-generated explanation and quiz will appear here.</p>
            </div>
        </div>

    </body>

    <!-- Core Logic (Updated for API Key handling) -->
    <script type="module">
        // The original Firebase imports are left here but will not be used on GitHub Pages
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let apiKey = localStorage.getItem('GEMINI_API_KEY') || ""; // Load key from local storage
        
        // UI Elements
        const userInput = document.getElementById('user-input');
        const examSelect = document.getElementById('exam-select');
        const getAnswerBtn = document.getElementById('get-answer-btn');
        const getQuizBtn = document.getElementById('get-quiz-btn');
        const responseArea = document.getElementById('response-area');
        const buttonText = document.getElementById('button-text');
        const apiKeySection = document.getElementById('api-key-section');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const appControls = document.getElementById('app-controls');
        const userIdDisplay = document.getElementById('user-id-display');
        
        let lastAnswer = '';
        let currentExam = 'UPSC';
        
        // We set up a dummy state for Firebase since it's disabled on GitHub Pages
        let isAuthReady = true; 
        let userId = crypto.randomUUID(); 
        userIdDisplay.textContent = `User ID: ${userId} (Storage Disabled)`;


        // --- Key Management and UI Control ---

        function updateUIBasedOnKey() {
            if (apiKey) {
                apiKeySection.classList.add('hidden');
                appControls.classList.remove('hidden');
                getAnswerBtn.disabled = false;
                userInput.focus();
            } else {
                apiKeySection.classList.remove('hidden');
                appControls.classList.add('hidden');
                getAnswerBtn.disabled = true;
                getQuizBtn.disabled = true;
                apiKeyInput.focus();
            }
        }

        function handleSaveApiKey() {
            const newKey = apiKeyInput.value.trim();
            if (newKey) {
                apiKey = newKey;
                localStorage.setItem('GEMINI_API_KEY', apiKey);
                updateUIBasedOnKey();
                responseArea.innerHTML = '<p class="text-green-600">API Key saved! You can now ask questions.</p>';
            } else {
                responseArea.innerHTML = '<p class="text-red-500">Please enter a valid API Key.</p>';
            }
        }

        // --- Core Application Logic ---

        // Helper for Exponential Backoff
        const MAX_RETRIES = 3;
        const INITIAL_DELAY_MS = 1000;
        
        // Fetching Data with Retries (for robustness)
        async function fetchWithRetry(url, options) {
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Crucial check: if 403 or 401, stop retrying as the key is bad
                        if (response.status === 403 || response.status === 401) {
                            localStorage.removeItem('GEMINI_API_KEY');
                            apiKey = "";
                            updateUIBasedOnKey();
                            throw new Error(`Authentication Error (${response.status}): Your API Key may be invalid or expired. Please check and re-enter.`);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt < MAX_RETRIES - 1) {
                        const delay = INITIAL_DELAY_MS * Math.pow(2, attempt) + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Gemini API Interaction (Text Generation)
        async function generateContent(userQuery, systemPrompt, useGrounding = false) {
            if (!apiKey) {
                return { text: "Error: No API Key found. Please enter your key to start the AI.", sources: [] };
            }

            const model = 'gemini-2.5-flash-preview-09-2025';
            // Use the key in the query parameter for simple HTML deployment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };
                } else {
                    console.error("API response missing text content:", result);
                    return { text: "Sorry, I couldn't generate a response. The API returned an unexpected format.", sources: [] };
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                // The error thrown from fetchWithRetry is caught here
                return { text: `Error generating content: ${error.message}`, sources: [] };
            }
        }
        
        // --- Event Handlers ---

        async function handleGetAnswer() {
            const query = userInput.value.trim();
            if (!query) {
                responseArea.innerHTML = '<p class="text-red-500">Please enter a question first.</p>';
                return;
            }
            if (!apiKey) {
                responseArea.innerHTML = '<p class="text-red-500">API Key is missing. Please enter your key above.</p>';
                updateUIBasedOnKey();
                return;
            }

            getAnswerBtn.disabled = true;
            getQuizBtn.disabled = true;
            buttonText.textContent = "Thinking...";
            responseArea.innerHTML = '<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div></div>';
            lastAnswer = ''; // Clear previous answer

            // 1. Generate Study Material
            const systemPrompt = `You are a world-class study tutor specializing in competitive exams. The user's focus is ${currentExam}. Provide a comprehensive, accurate, and easy-to-understand explanation specifically tailored to the knowledge depth required for the ${currentExam} exam. Use appropriate technical vocabulary for the specified exam level.`;
            const userQuery = `Explain the following topic for the ${currentExam} exam: ${query}`;
            
            const result = await generateContent(userQuery, systemPrompt, true);
            lastAnswer = result.text;
            
            // 2. Format and Display
            let htmlContent = `<h3 class="text-xl font-bold text-indigo-700 mb-2">‚úÖ Explanation for ${currentExam}:</h3>`;
            
            if (lastAnswer.startsWith("Error")) {
                 htmlContent += `<p class="text-red-500">${lastAnswer}</p>`;
                 getQuizBtn.disabled = true; // Disable quiz on error
            } else {
                htmlContent += `<div class="p-3 bg-white rounded-lg border border-gray-200"><pre>${lastAnswer}</pre></div>`;
                getQuizBtn.disabled = false; // Enable quiz after getting a successful answer
                
                if (result.sources && result.sources.length > 0) {
                    htmlContent += `<p class="text-xs mt-3 text-gray-500">Grounded in the following sources:</p><ul class="list-disc list-inside text-xs text-gray-500 mt-1">`;
                    result.sources.slice(0, 3).forEach(source => {
                        htmlContent += `<li><a href="${source.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700">${source.title}</a></li>`;
                    });
                    htmlContent += `</ul>`;
                }
            }
            
            responseArea.innerHTML = htmlContent;

            getAnswerBtn.disabled = false;
            buttonText.textContent = "Get Answer";
            
            if (lastAnswer.includes("Authentication Error")) {
                // If API key failed, disable buttons and show key input
                getAnswerBtn.disabled = true;
                getQuizBtn.disabled = true;
                updateUIBasedOnKey();
            }
        }

        async function handleGetQuiz() {
            if (!lastAnswer || lastAnswer.startsWith("Error")) {
                responseArea.innerHTML += '<p class="text-red-500 mt-4">Cannot generate quiz: Please get a valid explanation first.</p>';
                return;
            }

            getAnswerBtn.disabled = true;
            getQuizBtn.disabled = true;
            buttonText.textContent = "Generating Quiz...";
            
            // Add a loading spinner below the existing answer
            responseArea.innerHTML += '<div id="quiz-loader" class="mt-6 flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div></div>';

            // 1. Generate Quiz
            const systemPrompt = `You are a quiz master. Create a short, challenging quiz based ONLY on the provided explanation. Generate exactly two multiple-choice questions (MCQs) and one short answer question (SAQ) suitable for a student preparing for the ${currentExam} exam. Format the output clearly with question numbers and options, but do not include answers or explanations.`;
            const userQuery = `Generate a 2-question MCQ and 1-question SAQ based on this text: \n\n${lastAnswer}`;
            
            const result = await generateContent(userQuery, systemPrompt, false);
            
            // Remove loader
            const quizLoader = document.getElementById('quiz-loader');
            if (quizLoader) quizLoader.remove();

            // 2. Format and Display
            let htmlContent = `<h3 class="text-xl font-bold text-green-600 mt-6 mb-2">üìù Practice Quiz:</h3>`;
            
             if (result.text.startsWith("Error")) {
                 htmlContent += `<p class="text-red-500">${result.text}</p>`;
            } else {
                htmlContent += `<div class="p-3 bg-white rounded-lg border border-gray-200"><pre>${result.text}</pre></div>`;
            }

            responseArea.innerHTML += htmlContent;

            getAnswerBtn.disabled = false;
            getQuizBtn.disabled = false;
            buttonText.textContent = "Get Answer";
        }

        function handleExamChange() {
            currentExam = examSelect.value;
            // No saving on GitHub Pages, just local state change
        }

        // --- Initialization and Event Listeners ---

        function initApp() {
            // 1. Hide loader and show main content
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            // 2. Check for existing API key and update UI
            updateUIBasedOnKey();

            // 3. Attach Event Listeners
            getAnswerBtn.addEventListener('click', handleGetAnswer);
            getQuizBtn.addEventListener('click', handleGetQuiz);
            examSelect.addEventListener('change', handleExamChange);
            saveApiKeyBtn.addEventListener('click', handleSaveApiKey);
            apiKeyInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSaveApiKey();
                }
            });
            
            // Allow ENTER key to trigger search
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !getAnswerBtn.disabled) {
                    e.preventDefault();
                    handleGetAnswer();
                }
            });
        }
        
        // Start the application after the script loads
        initApp();
    </script>
    <!-- CACHE BUSTER 20251101_FINAL_FIX_V3 -->
</html>
